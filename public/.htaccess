<IfModule mod_rewrite.c>
    <IfModule mod_negotiation.c>
        Options -MultiViews -Indexes
    </IfModule>

    RewriteEngine On

    # Handle Authorization Header
    RewriteCond %{HTTP:Authorization} .
    RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]

    # Redirect Trailing Slashes If Not A Folder...
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_URI} (.+)/$
    RewriteRule ^ %1 [L,R=301]

    # Send Requests To Front Controller...
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteRule ^ index.php [L]
</IfModule>

# ===============================================
# إعدادات محسنة للملفات الكبيرة
# Large File Support Enhancements
# ===============================================

<IfModule mod_php.c>
    # زيادة حد وقت التنفيذ إلى 30 دقيقة للملفات الكبيرة
    php_value max_execution_time 1800

    # زيادة حد الذاكرة إلى 512MB
    php_value memory_limit 512M

    # زيادة حد وقت الإدخال إلى 10 دقائق
    php_value max_input_time 600

    # زيادة حد عدد متغيرات الإدخال
    php_value max_input_vars 5000

    # زيادة حد حجم الملف المرفوع إلى 50MB
    php_value upload_max_filesize 50M

    # زيادة حد حجم البيانات المرسلة إلى 100MB
    php_value post_max_size 100M

    # زيادة حد عدد الملفات المرفوعة
    php_value max_file_uploads 20

    # تحسين إعدادات PCRE للبيانات الكبيرة
    php_value pcre.backtrack_limit 5000000
    php_value pcre.recursion_limit 100000

    # تفعيل ضغط الإخراج لتحسين الأداء
    php_flag zlib.output_compression On

    # تحسين إعدادات الجلسة للملفات الكبيرة
    php_value session.gc_maxlifetime 7200
    php_flag session.cookie_httponly On
    php_flag session.use_strict_mode On
</IfModule>

# إعدادات خاصة لـ PHP-FPM
<IfModule mod_fcgid.c>
    FcgidIOTimeout 1800
    FcgidConnectTimeout 1800
    FcgidBusyTimeout 1800
    FcgidIdleTimeout 1800
    FcgidMaxRequestLen 104857600
</IfModule>

# إعدادات الأمان والحماية
<IfModule mod_headers.c>
    # إضافة headers أمان
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"

    # إعدادات خاصة للملفات الكبيرة
    <FilesMatch "\.(php)$">
        Header set X-Large-File-Support "enabled"
        Header set X-Max-Execution-Time "1800"
        Header set X-Memory-Limit "512M"
    </FilesMatch>
</IfModule>

# إعدادات خاصة لملفات البيانات
<FilesMatch "\.(csv|xlsx|xls)$">
    # زيادة حدود خاصة لملفات البيانات
    <IfModule mod_php.c>
        php_value max_execution_time 1800
        php_value memory_limit 1024M
        php_value max_input_time 900
    </IfModule>

    # إضافة headers للملفات الكبيرة
    <IfModule mod_headers.c>
        Header set X-Large-Data-File "true"
        Header set Cache-Control "no-cache, no-store, must-revalidate"
    </IfModule>
</FilesMatch>

# تحسين أداء Apache للملفات الكبيرة
<IfModule mod_reqtimeout.c>
    RequestReadTimeout header=300,MinRate=500 body=1800,MinRate=500
</IfModule>
